<!-- _includes/menu -->
<div class="nav-band">
  <div class="menu" role="navigation" aria-label="Site">

    <details class="menu-collapsible" data-autotoggle>
      <summary class="menu-summary" aria-label="Open main menu">Menu</summary>

      <nav class="menu-content" aria-label="Main">
        {%- comment -%}
        Normalize the current page path once (raw path, no base/host)
        Examples: "/" , "/cv.html" , "/menu/currentresearch.html" , "/menu/"
        {%- endcomment -%}
        {% assign current = page.url | replace: 'index.html','' %}
        {% assign current_slash = current %}
        {% unless current == '/' %}
          {% assign current_slash = current | append: '/' %}
        {% endunless %}

        {% for item in site.data.settings.menu %}
          {% assign path = item.path | default: '' %}
          {% capture base_path %}{% if path != '' %}/{{ path }}{% endif %}{% endcapture %}

          {% if item.submenu %}
            {%- comment -%} Check if any child matches exactly {%- endcomment -%}
            {% assign sub_active = false %}
            {% for subitem in item.submenu %}
              {% assign subpath = subitem.path | default: path %}
              {% capture subhref %}{% if subpath != '' %}/{{ subpath }}{% endif %}/{{ subitem.url }}{% endcapture %}
              {% if current == subhref or current_slash == subhref %}
                {% assign sub_active = true %}
              {% endif %}
            {% endfor %}

            <div class="dropdown">
              {% if item.url %}
                {% capture parent_href %}{{ base_path }}/{{ item.url }}{% endcapture %}
                {% assign is_parent_active = (current == parent_href or current_slash == parent_href) or sub_active %}
                <a
                  class="menu-link parent-link has-sub{% if is_parent_active %} active{% endif %}"
                  href="{{ parent_href | relative_url }}"
                  {% if is_parent_active %}aria-current="page"{% endif %}
                >
                  {{ item.name }} <span class="caret" aria-hidden="true">▾</span>
                </a>
              {% else %}
                {% assign is_parent_active = sub_active %}
                <span
                  class="menu-link has-sub{% if is_parent_active %} active{% endif %}"
                  {% if is_parent_active %}aria-current="page"{% endif %}
                  tabindex="0"
                >
                  {{ item.name }} <span class="caret" aria-hidden="true">▾</span>
                </span>
              {% endif %}

              <div class="dropdown-content" role="menu">
                {% for subitem in item.submenu %}
                  {% assign subpath = subitem.path | default: path %}
                  {% capture subhref %}{% if subpath != '' %}/{{ subpath }}{% endif %}/{{ subitem.url }}{% endcapture %}
                  {% assign is_active_child = (current == subhref or current_slash == subhref) %}
                  <a
                    role="menuitem"
                    href="{{ subhref | relative_url }}"
                    class="{% if is_active_child %}active{% endif %}"
                    {% if is_active_child %}aria-current="page"{% endif %}
                  >
                    {{ subitem.name }}
                  </a>
                {% endfor %}
              </div>
            </div>

          {% else %}
            {% if item.url %}
              {% capture href %}{{ base_path }}/{{ item.url }}{% endcapture %}
              {% assign is_active = (current == href or current_slash == href) %}
              <a
                class="menu-link{% if is_active %} active{% endif %}"
                href="{{ href | relative_url }}"
                {% if is_active %}aria-current="page"{% endif %}
              >
                {{ item.name }}
              </a>
            {% endif %}
          {% endif %}
        {% endfor %}
      </nav>
    </details>

    <nav class="social-icons" aria-label="Social">
      {% for item in site.data.settings.social %}
        <a href="{{ item.link }}" target="_blank" rel="noopener">
          <i class="fa fa-{{ item.icon }}" aria-hidden="true"></i>
          <span class="sr-only">{{ item.icon }}</span>
        </a>
      {% endfor %}
    </nav>
  </div>
</div>

<script>
(function () {
  var d = document.querySelector('.menu-collapsible');
  if (!d) return;
  var mq = window.matchMedia('(min-width: 761px)');
  function apply(){ d.open = mq.matches; }
  apply();
  (mq.addEventListener ? mq.addEventListener('change', apply) : mq.addListener(apply));

  // Close after tapping a link on mobile
  document.addEventListener('click', function (e) {
    if (e.target.closest('.menu-content a') && window.matchMedia('(max-width: 760px)').matches) {
      d.open = false;
    }
  });
})();
</script>

